<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In Phi·∫øu Xu·∫•t Kho</title>
    <style>
        /* CSS GI·ªÆ NGUY√äN NH∆Ø C≈® */
        body { font-family: "Times New Roman", Times, serif; font-size: 13pt; line-height: 1.3; margin: 0; padding: 20px; }
        .container { width: 100%; max-width: 210mm; margin: 0 auto; }
        .header-table { width: 100%; border: none; margin-bottom: 20px; }
        .company-name { font-weight: bold; font-size: 14pt; text-transform: uppercase; }
        .title { text-align: center; font-weight: bold; font-size: 20pt; margin-top: 10px; margin-bottom: 5px; }
        .stars { text-align: center; font-size: 14pt; color: #f39c12; }
        .info-section { width: 100%; margin-bottom: 15px; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .info-left { width: 60%; }
        .info-right { width: 40%; text-align: right; }
        .label { text-decoration: underline; }
        .main-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 11pt; }
        .main-table th, .main-table td { border: 1px solid black; padding: 5px; vertical-align: middle; }
        .main-table th { background-color: #dbe5f1; text-align: center; font-weight: bold; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .footer-table { width: 100%; text-align: center; margin-top: 30px; }
        .footer-table td { vertical-align: top; padding-bottom: 80px; }
        .footer-title { font-weight: bold; text-decoration: underline; }
        .footer-note { font-style: italic; font-size: 11pt; }
        
        /* Loading overlay */
        #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:white; display:flex; justify-content:center; align-items:center; z-index:999; font-size: 20px; font-weight: bold;}
        .hidden { display: none !important; }
        
        @media print {
            .no-print { display: none; }
            @page { margin: 10mm; size: A4; }
        }
        .print-btn { position: fixed; top: 10px; right: 10px; padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 5px; }
    </style>
</head>
<body>
    <div id="loading">‚è≥ ƒêang t·∫£i d·ªØ li·ªáu phi·∫øu...</div>

    <button class="no-print print-btn" onclick="window.print()">üñ®Ô∏è IN PHI·∫æU</button>

    <div class="container" id="content">
        <table class="header-table">
            <tr>
                <td width="15%" style="vertical-align: top;">
                    <img src="https://i.imgur.com/Placeholder.png" style="width: 80px;" alt="Logo">
                    <div style="font-size: 9pt; font-weight: bold; color: orange; text-align: center;">TR∆Ø·ªúNG AN</div>
                </td>
                <td style="text-align: center; vertical-align: top;">
                    <div class="company-name">C√îNG TY C·ªî PH·∫¶N C∆† ƒêI·ªÜN V√Ä PCCC TR∆Ø·ªúNG AN</div>
                    <div class="stars">‚òÖ‚òÖ‚òÖ</div>
                    <div class="title">PHI·∫æU XU·∫§T KHO</div>
                </td>
            </tr>
        </table>

        <div class="info-section">
            <div class="info-row">
                <div class="info-left"><span class="label">D·ª± √°n:</span> NH√Ä M√ÅY GOERTEK (GIAI ƒêO·∫†N 3)</div>
                <div class="info-right"><span class="label">S·ªë phi·∫øu:</span> <b id="val-soPhieu">...</b></div>
            </div>
            <div class="info-row">
                <div class="info-left"><span class="label">Nh√† x∆∞·ªüng:</span> <span id="val-xuong">...</span></div>
                <div class="info-right"><span class="label">Ng√†y/th√°ng:</span> <span id="val-ngay">...</span></div>
            </div>
            <div class="info-row">
                <div class="info-left"><span class="label">T·ªï ƒë·ªôi:</span> <span id="val-nhaCungCap">...</span></div>
            </div>
            <div class="info-row">
                <div class="info-left"><span class="label">Di·ªÖn gi·∫£i:</span> <span id="val-dienGiai">...</span></div>
            </div>
        </div>

        <table class="main-table">
            <thead>
                <tr>
                    <th width="5%">Stt</th>
                    <th width="10%">M√£ v·∫≠t t∆∞</th>
                    <th width="30%">T√™n v·∫≠t t∆∞, thi·∫øt b·ªã</th>
                    <th width="8%">ƒêVT</th>
                    <th width="10%">Quy c√°ch</th>
                    <th width="10%">Nh√£n hi·ªáu</th>
                    <th width="8%">SL ƒë·ªÅ ngh·ªã</th>
                    <th width="8%">Th·ª±c xu·∫•t</th>
                    <th width="11%">Ghi ch√∫</th>
                </tr>
            </thead>
            <tbody id="table-body">
                </tbody>
        </table>

        <table class="footer-table">
            <tr>
                <td width="25%"><div class="footer-title">Ph√™ duy·ªát</div><div class="footer-note">(K√Ω, ghi r√µ h·ªç t√™n)</div></td>
                <td width="25%"><div class="footer-title">Ng∆∞·ªùi l·∫≠p</div><div class="footer-note">(K√Ω, ghi r√µ h·ªç t√™n)</div></td>
                <td width="25%"><div class="footer-title">Ng∆∞·ªùi nh·∫≠n</div><div class="footer-note">(K√Ω, ghi r√µ h·ªç t√™n)</div></td>
                <td width="25%"><div class="footer-title">Th·ªß kho</div><div class="footer-note">(K√Ω, ghi r√µ h·ªç t√™n)</div></td>
            </tr>
        </table>
    </div>

    <script>
        // --- C·∫§U H√åNH LINK WEB APP C·ª¶A B·∫†N T·∫†I ƒê√ÇY ---
        const GAS_API_URL = "https://n8n.pccctruongan.com.vn/webhook/in-phieu"; 
        // ---------------------------------------------

        async function loadData() {
            // L·∫•y s·ªë phi·∫øu t·ª´ URL tr√¨nh duy·ªát (v√≠ d·ª•: vercel-app.com?soPhieu=ABC)
            const params = new URLSearchParams(window.location.search);
            const soPhieu = params.get('soPhieu');

            if (!soPhieu) {
                alert("Kh√¥ng t√¨m th·∫•y s·ªë phi·∫øu tr√™n URL!");
                document.getElementById('loading').innerText = "Thi·∫øu s·ªë phi·∫øu";
                return;
            }

            try {
                // G·ªçi API l·∫•y d·ªØ li·ªáu
                // Th√™m tham s·ªë redirect ƒë·ªÉ x·ª≠ l√Ω chuy·ªÉn h∆∞·ªõng c·ªßa Google
                const response = await fetch(GAS_API_URL + "?soPhieu=" + encodeURIComponent(soPhieu), {
                    method: "GET",
                    redirect: "follow" 
                });
                
                const data = await response.json();

                if (data.status !== "success") {
                    throw new Error("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu phi·∫øu n√†y trong Sheet.");
                }

                // ƒê·ªï d·ªØ li·ªáu Master
                document.getElementById('val-soPhieu').innerText = data.master.soPhieu;
                document.getElementById('val-xuong').innerText = data.master.xuong;
                document.getElementById('val-ngay').innerText = data.master.ngay;
                document.getElementById('val-nhaCungCap').innerText = data.master.nhaCungCap;
                document.getElementById('val-dienGiai').innerText = data.master.dienGiai;

                // ƒê·ªï d·ªØ li·ªáu B·∫£ng chi ti·∫øt
                const tbody = document.getElementById('table-body');
                let html = "";
                data.items.forEach((item, index) => {
                    html += `
                        <tr>
                            <td class="text-center">${index + 1}</td>
                            <td>${item.maVT}</td>
                            <td>${item.tenVT}</td>
                            <td class="text-center">${item.dvt}</td>
                            <td>${item.quyCach}</td>
                            <td>${item.nhanHieu}</td>
                            <td class="text-right">${item.slDeNghi}</td>
                            <td class="text-right">${item.thucXuat}</td>
                            <td>${item.ghiChu}</td>
                        </tr>
                    `;
                });
                
                // Th√™m d√≤ng tr·ªëng cho ƒë·∫πp n·∫øu √≠t d·ªØ li·ªáu
                if(data.items.length < 5) {
                    for(let k=0; k < (5 - data.items.length); k++) {
                        html += `<tr><td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr>`;
                    }
                }

                tbody.innerHTML = html;

                // T·∫Øt m√†n h√¨nh loading
                document.getElementById('loading').classList.add('hidden');

            } catch (error) {
                console.error(error);
                document.getElementById('loading').innerText = "L·ªói: " + error.message;
                document.getElementById('loading').style.color = "red";
            }
        }

        // Ch·∫°y h√†m khi trang t·∫£i xong
        window.onload = loadData;
    </script>
</body>
</html>
